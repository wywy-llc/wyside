<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wyside Todo</title>
    <base target="_top" />
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        padding: 12px;
      }
      h3 {
        margin-top: 0;
        color: #1a73e8;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
      }
      .todo-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f3f4;
      }
      .todo-text {
        flex: 1;
        margin-left: 8px;
      }
      .completed .todo-text {
        text-decoration: line-through;
        color: #bdc1c6;
      }
      button.delete-btn {
        background: none;
        border: none;
        color: #ea4335;
        cursor: pointer;
        font-size: 1.1em;
        padding: 0 4px;
      }
      button.delete-btn:hover {
        background-color: #fee;
      }
      button.delete-btn:focus {
        outline: 2px solid #ea4335;
        outline-offset: 2px;
      }
      #add-form {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      input[type='text'] {
        flex: 1;
        padding: 6px;
        border: 1px solid #dadce0;
        border-radius: 4px;
      }
      input[type='text']:focus {
        outline: 2px solid #1a73e8;
        outline-offset: 2px;
        border-color: #1a73e8;
      }
      input[type='checkbox']:focus {
        outline: 2px solid #1a73e8;
        outline-offset: 2px;
      }
      button[type='submit'] {
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
      }
      button[type='submit']:hover:not(:disabled) {
        background: #1765cc;
      }
      button[type='submit']:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      button[type='submit']:focus {
        outline: 2px solid #1a73e8;
        outline-offset: 2px;
      }
      /* Add loading state */
      .loading {
        opacity: 0.5;
        pointer-events: none;
      }
      /* Empty state */
      .empty-state {
        color: #888;
        font-style: italic;
        padding: 16px 0;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <main>
      <h3>Wyside Todo</h3>
      <form id="add-form">
        <label for="new-todo" class="sr-only">New task</label>
        <input
          type="text"
          id="new-todo"
          name="new-todo"
          placeholder="New task..."
          required
          aria-required="true"
        />
        <button type="submit" id="add-btn" aria-label="Add new task">
          Add
        </button>
      </form>
      <div
        id="todo-list"
        role="list"
        aria-live="polite"
        aria-label="Todo list"
      >
        Loading...
      </div>
    </main>

    <script>
      (function () {
        'use strict';

        // Check if Google Apps Script API is available
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          console.warn('Google Apps Script API not available');
          return;
        }

        // Cache DOM references
        const todoListEl = document.getElementById('todo-list');
        const addForm = document.getElementById('add-form');
        const newTodoInput = document.getElementById('new-todo');
        const addBtn = document.getElementById('add-btn');

        /**
         * Renders the todo list
         * @param {Array<{id: string, title: string, completed: boolean}>} todos - Array of todo items
         */
        function render(todos) {
          // Use DocumentFragment for batch DOM updates
          const fragment = document.createDocumentFragment();

          if (todos.length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-state';
            emptyDiv.textContent = 'No tasks yet.';
            fragment.appendChild(emptyDiv);
          } else {
            todos.forEach(todo => {
              const div = document.createElement('div');
              div.className = 'todo-item ' + (todo.completed ? 'completed' : '');
              div.setAttribute('role', 'listitem');
              div.dataset.id = todo.id;

              // Create checkbox
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.checked = todo.completed;
              checkbox.setAttribute('aria-label', 'Mark as ' + (todo.completed ? 'incomplete' : 'complete'));

              // Create text span
              const span = document.createElement('span');
              span.className = 'todo-text';
              span.textContent = todo.title; // XSS protection

              // Create delete button
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'delete-btn';
              deleteBtn.type = 'button';
              deleteBtn.textContent = 'Ã—';
              deleteBtn.setAttribute('aria-label', 'Delete task: ' + todo.title);

              div.appendChild(checkbox);
              div.appendChild(span);
              div.appendChild(deleteBtn);
              fragment.appendChild(div);
            });
          }

          // Single DOM update
          todoListEl.innerHTML = '';
          todoListEl.appendChild(fragment);
        }

        /**
         * Loads todos from server
         */
        function load() {
          todoListEl.classList.add('loading');
          google.script.run
            .withSuccessHandler(todos => {
              render(todos);
              todoListEl.classList.remove('loading');
            })
            .withFailureHandler(err => {
              handleError(err);
              todoListEl.classList.remove('loading');
            })
            .apiListTodos();
        }

        /**
         * Handles errors
         * @param {Error|string} err - Error object or message
         */
        function handleError(err) {
          const message = err.message || err.toString();
          alert('Error: ' + message);
        }

        /**
         * Handles form submission to add a new todo
         * @param {Event} event - Submit event
         */
        function handleAddSubmit(event) {
          event.preventDefault();
          const title = newTodoInput.value.trim();
          if (!title) return;

          const originalText = addBtn.textContent;
          addBtn.disabled = true;
          addBtn.textContent = '...';

          google.script.run
            .withSuccessHandler(() => {
              newTodoInput.value = '';
              addBtn.disabled = false;
              addBtn.textContent = originalText;
              load();
            })
            .withFailureHandler(err => {
              handleError(err);
              addBtn.disabled = false;
              addBtn.textContent = originalText;
            })
            .apiAddTodo(title);
        }

        /**
         * Handles toggling a todo's completion status
         * @param {string} id - Todo ID
         * @param {HTMLInputElement} checkbox - Checkbox element
         */
        function handleToggle(id, checkbox) {
          const div = todoListEl.querySelector(`[data-id="${id}"]`);
          if (!div) return;

          const checkboxEl = div.querySelector('input[type="checkbox"]');
          if (!checkboxEl) return;

          const newCheckedState = checkboxEl.checked;

          // Update UI optimistically
          if (newCheckedState) {
            div.classList.add('completed');
          } else {
            div.classList.remove('completed');
          }

          // Update aria-label
          checkboxEl.setAttribute(
            'aria-label',
            'Mark as ' + (newCheckedState ? 'incomplete' : 'complete')
          );

          // Send to server
          google.script.run
            .withFailureHandler(err => {
              // Rollback on error: revert checkbox and class
              checkboxEl.checked = !newCheckedState;
              if (newCheckedState) {
                div.classList.remove('completed');
              } else {
                div.classList.add('completed');
              }
              checkboxEl.setAttribute(
                'aria-label',
                'Mark as ' + (!newCheckedState ? 'incomplete' : 'complete')
              );
              handleError(err);
              load(); // Sync with server
            })
            .apiToggleTodo(id);
        }

        /**
         * Handles removing a todo
         * @param {string} id - Todo ID
         */
        function handleRemove(id) {
          if (!confirm('Delete this task?')) return;

          // Optimistic removal
          const item = todoListEl.querySelector(`[data-id="${id}"]`);
          if (!item) return;

          const removedHTML = item.outerHTML;
          const parent = item.parentNode;
          const nextSibling = item.nextSibling;

          item.remove();

          google.script.run
            .withFailureHandler(err => {
              // Rollback on error: re-insert element
              if (parent) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = removedHTML;
                parent.insertBefore(tempDiv.firstChild, nextSibling);
              }
              handleError(err);
              load(); // Sync with server
            })
            .apiDeleteTodo(id);
        }

        // Event listeners
        addForm.addEventListener('submit', handleAddSubmit);

        // Event delegation for todo list
        todoListEl.addEventListener('change', (e) => {
          if (e.target.type === 'checkbox') {
            const item = e.target.closest('[data-id]');
            if (item) {
              handleToggle(item.dataset.id, e.target);
            }
          }
        });

        todoListEl.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete-btn')) {
            const item = e.target.closest('[data-id]');
            if (item) {
              handleRemove(item.dataset.id);
            }
          }
        });

        // Initial load
        load();
      })();
    </script>
  </body>
</html>