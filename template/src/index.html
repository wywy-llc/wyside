<!doctype html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        padding: 12px;
      }
      h3 {
        margin-top: 0;
        color: #1a73e8;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
      }
      .todo-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f3f4;
      }
      .todo-text {
        flex: 1;
        margin-left: 8px;
      }
      .completed .todo-text {
        text-decoration: line-through;
        color: #bdc1c6;
      }
      button.delete-btn {
        background: none;
        border: none;
        color: #ea4335;
        cursor: pointer;
        font-size: 1.1em;
        padding: 0 4px;
      }
      #add-form {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      input[type='text'] {
        flex: 1;
        padding: 6px;
        border: 1px solid #dadce0;
        border-radius: 4px;
      }
      button[type='submit'] {
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
      }
      button[type='submit']:hover {
        background: #1765cc;
      }
      /* Add loading state */
      .loading {
        opacity: 0.5;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <h3>Wyside Todo</h3>
    <form id="add-form">
      <input type="text" id="new-todo" placeholder="New task..." required />
      <button type="submit" id="add-btn">Add</button>
    </form>
    <div id="todo-list">Loading...</div>

    <script>
      // Cache DOM references
      const todoListEl = document.getElementById('todo-list');
      const addForm = document.getElementById('add-form');
      const newTodoInput = document.getElementById('new-todo');
      const addBtn = document.getElementById('add-btn');

      function render(todos) {
        // Use DocumentFragment for batch DOM updates
        const fragment = document.createDocumentFragment();

        if (todos.length === 0) {
          const emptyDiv = document.createElement('div');
          emptyDiv.style.cssText = 'color: #888; font-style: italic;';
          emptyDiv.textContent = 'No tasks yet.';
          fragment.appendChild(emptyDiv);
        } else {
          todos.forEach(todo => {
            const div = document.createElement('div');
            div.className = 'todo-item ' + (todo.completed ? 'completed' : '');
            div.dataset.id = todo.id;

            // Use DOM API instead of innerHTML for security and speed
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = todo.completed;
            checkbox.onchange = () => toggle(todo.id);

            const span = document.createElement('span');
            span.className = 'todo-text';
            span.textContent = todo.title; // XSS protection

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'Ã—';
            deleteBtn.title = 'Delete';
            deleteBtn.onclick = () => remove(todo.id);

            div.appendChild(checkbox);
            div.appendChild(span);
            div.appendChild(deleteBtn);
            fragment.appendChild(div);
          });
        }

        // Single DOM update
        todoListEl.innerHTML = '';
        todoListEl.appendChild(fragment);
      }

      function load() {
        todoListEl.classList.add('loading');
        google.script.run
          .withSuccessHandler(todos => {
            render(todos);
            todoListEl.classList.remove('loading');
          })
          .withFailureHandler(handleError)
          .apiListTodos();
      }

      // Reusable error handler
      function handleError(err) {
        alert('Error: ' + err);
        todoListEl.classList.remove('loading');
      }

      addForm.addEventListener('submit', e => {
        e.preventDefault();
        const title = newTodoInput.value.trim();
        if (!title) return;

        const originalText = addBtn.textContent;
        addBtn.disabled = true;
        addBtn.textContent = '...';

        google.script.run
          .withSuccessHandler(() => {
            newTodoInput.value = '';
            addBtn.disabled = false;
            addBtn.textContent = originalText;
            load();
          })
          .withFailureHandler(err => {
            handleError(err);
            addBtn.disabled = false;
            addBtn.textContent = originalText;
          })
          .apiAddTodo(title);
      });

      function toggle(id) {
        // Optimistic UI update
        const item = todoListEl.querySelector(`[data-id="${id}"]`);
        if (item) {
          item.classList.toggle('completed');
          const checkbox = item.querySelector('input[type="checkbox"]');
          if (checkbox) checkbox.checked = !checkbox.checked;
        }

        google.script.run
          .withSuccessHandler(() => {
            // No full reload needed - optimistic update already applied
          })
          .withFailureHandler(err => {
            // Rollback on error
            if (item) item.classList.toggle('completed');
            handleError(err);
            load(); // Sync with server
          })
          .apiToggleTodo(id);
      }

      function remove(id) {
        if (!confirm('Delete this task?')) return;

        // Optimistic removal
        const item = todoListEl.querySelector(`[data-id="${id}"]`);
        const removedItem = item ? item.cloneNode(true) : null;
        if (item) item.remove();

        google.script.run
          .withSuccessHandler(() => {
            // Already removed optimistically
          })
          .withFailureHandler(err => {
            // Rollback on error
            if (removedItem && item && item.parentNode) {
              item.parentNode.insertBefore(removedItem, item.nextSibling);
            }
            handleError(err);
            load(); // Sync with server
          })
          .apiDeleteTodo(id);
      }

      // Initial load
      if (typeof google !== 'undefined') {
        load();
      }
    </script>
  </body>
</html>
