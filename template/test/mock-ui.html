<!doctype html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        padding: 12px;
      }
      h3 {
        margin-top: 0;
        color: #1a73e8;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
      }
      .todo-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f3f4;
      }
      .todo-text {
        flex: 1;
        margin-left: 8px;
      }
      .completed .todo-text {
        text-decoration: line-through;
        color: #bdc1c6;
      }
      button.delete-btn {
        background: none;
        border: none;
        color: #ea4335;
        cursor: pointer;
        font-size: 1.1em;
        padding: 0 4px;
      }
      #add-form {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      input[type='text'] {
        flex: 1;
        padding: 6px;
        border: 1px solid #dadce0;
        border-radius: 4px;
      }
      button[type='submit'] {
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
      }
      button[type='submit']:hover {
        background: #1765cc;
      }
    </style>
    <script>
      // MOCK GAS ENVIRONMENT
      const todos = [{ id: '1', title: 'Existing Task', completed: false }];

      function createRunner() {
        return {
          _success: () => {},
          _failure: console.error,
          withSuccessHandler(cb) {
            this._success = cb;
            return this;
          },
          withFailureHandler(cb) {
            this._failure = cb;
            return this;
          },
          apiListTodos() {
            setTimeout(() => this._success(todos), 100);
          },
          apiAddTodo(title) {
            const t = { id: String(Date.now()), title, completed: false };
            todos.push(t);
            setTimeout(() => this._success(t), 100);
          },
          apiToggleTodo(id) {
            const t = todos.find(x => x.id === id);
            if (t) t.completed = !t.completed;
            setTimeout(() => this._success(), 100);
          },
          apiDeleteTodo(id) {
            const idx = todos.findIndex(x => x.id === id);
            if (idx > -1) todos.splice(idx, 1);
            setTimeout(() => this._success(), 100);
          },
        };
      }

      window.google = {
        script: {
          run: new Proxy(
            {},
            {
              get: (_, prop) => {
                const runner = createRunner();
                return runner[prop] ? runner[prop].bind(runner) : undefined;
              },
            }
          ),
        },
      };

      window.confirm = () => true;
    </script>
  </head>
  <body>
    <h3>Wyside Todo</h3>
    <form id="add-form">
      <input type="text" id="new-todo" placeholder="New task..." required />
      <button type="submit" id="add-btn">Add</button>
    </form>
    <div id="todo-list">Loading...</div>

    <script>
      // ORIGINAL SCRIPT
      function render(todos) {
        const list = document.getElementById('todo-list');
        list.innerHTML = '';
        if (todos.length === 0) {
          list.innerHTML =
            '<div style="color: #888; font-style: italic;">No tasks yet.</div>';
          return;
        }
        todos.forEach(todo => {
          const div = document.createElement('div');
          div.className = 'todo-item ' + (todo.completed ? 'completed' : '');
          div.innerHTML = `
            <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                   onchange="toggle('${todo.id}')">
            <span class="todo-text">${todo.title}</span>
            <button class="delete-btn" onclick="remove('${todo.id}')" title="Delete">&times;</button>
          `;
          list.appendChild(div);
        });
      }

      function load() {
        google.script.run
          .withSuccessHandler(render)
          .withFailureHandler(err => alert('Error: ' + err))
          .apiListTodos();
      }

      document.getElementById('add-form').addEventListener('submit', e => {
        e.preventDefault();
        const input = document.getElementById('new-todo');
        const btn = document.getElementById('add-btn');
        const originalText = btn.innerText;

        btn.disabled = true;
        btn.innerText = '...';

        google.script.run
          .withSuccessHandler(() => {
            input.value = '';
            btn.disabled = false;
            btn.innerText = originalText;
            load();
          })
          .withFailureHandler(err => {
            alert('Error: ' + err);
            btn.disabled = false;
            btn.innerText = originalText;
          })
          .apiAddTodo(input.value);
      });

      function toggle(id) {
        // Optimistic update could go here
        google.script.run
          .withSuccessHandler(load)
          .withFailureHandler(alert)
          .apiToggleTodo(id);
      }

      function remove(id) {
        if (!confirm('Delete this task?')) return;
        google.script.run
          .withSuccessHandler(load)
          .withFailureHandler(alert)
          .apiDeleteTodo(id);
      }

      // Initial load
      if (typeof google !== 'undefined') {
        load();
      }
    </script>
  </body>
</html>
