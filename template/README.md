# Wyside Template Project

This project was generated by `wyside`. It features a Unified Architecture that runs on both Google Apps Script (GAS) and Node.js (Local).

## Setup

1. Install dependencies:

   ```bash
   npm install
   ```

2. Configure Secrets:
   Place your Google Cloud Service Account key in `secrets/service-account.json`.

3. Configure Environment:
   Copy `.env.example` to `.env` and fill in the values.

## Detailed Setup Guide

If you are setting this up from scratch, follow these steps to obtain the necessary credentials and IDs.

### 1. Google Cloud Project & API

1. Go to the [Google Cloud Console](https://console.cloud.google.com/).
2. Create a new project (or select an existing one).
3. Note the **Project ID** (e.g., `my-project-123`). This is your `GCP_PROJECT_ID`.
4. Navigate to **APIs & Services > Library**.
5. Search for and enable the following APIs:
   - **Google Sheets API**
   - **Google Drive API**
   - **Gmail API**

### 2. Service Account (For Local Execution)

1. Navigate to **IAM & Admin > Service Accounts**.
2. Click **Create Service Account**.
3. Give it a name (e.g., `wyside`).
4. (Optional) Grant "Editor" role if you want it to manage cloud resources, but for Sheets API, specific sharing (Step 3) is usually enough.
5. Click **Done**.
6. Click on the newly created service account (email format: `name@project-id.iam.gserviceaccount.com`).
7. Go to the **Keys** tab > **Add Key** > **Create new key**.
8. Select **JSON** and download the file.
9. Rename the file to `service-account.json` and place it in the `secrets/` directory of this project:

   ```
   secrets/service-account.json
   ```

   _(Note: `secrets/` is git-ignored by default to prevent accidental commits)_

**Note about Gmail API:**

- For Gmail API access with a Service Account, you typically need **Domain-Wide Delegation** enabled if you're using Google Workspace.
- For personal Gmail accounts, Service Accounts cannot directly access user emails. Consider using OAuth 2.0 user authentication instead.
- The current setup in `appsscript.json` includes Gmail API permissions for GAS runtime. For local development with Gmail, you may need to implement OAuth 2.0 flow.

### 3. Spreadsheets Setup

1. Create Google Sheets for **Development** and **Production** (up to 5 sheets can be configured per environment).
   - The URL will look like `https://docs.google.com/spreadsheets/d/YOUR_SPREADSHEET_ID/edit`.
   - Copy the `YOUR_SPREADSHEET_ID` part.
   - These will be your `APP_SPREADSHEET_ID_1_DEV`, `APP_SPREADSHEET_ID_1_PROD`, etc.
2. **Crucial Step**: Share all spreadsheets with your Service Account.
   - Copy the Service Account email address from Step 2.
   - In each Google Sheet, click **Share** button.
   - Paste the Service Account email and give it **Editor** access.
   - _Without this, local tests will fail with 403 Forbidden errors._

### 4. Environment Configuration

Create a `.env` file in the project root:

```bash
cp .env.example .env
```

Edit `.env` with your gathered values:

```ini
# Your GCP Project ID from Step 1
GCP_PROJECT_ID=my-project-123

# Development Spreadsheets (up to 5 can be configured)
APP_SPREADSHEET_ID_1_DEV=1ABC...xyz
APP_SPREADSHEET_ID_2_DEV=1DEF...uvw
# ... add more as needed

# Production Spreadsheets
APP_SPREADSHEET_ID_1_PROD=1GHI...rst
APP_SPREADSHEET_ID_2_PROD=1JKL...mno
# ... add more as needed

# Path to your key file (Default is fine)
GOOGLE_APPLICATION_CREDENTIALS=./secrets/service-account.json
```

**Note:** Use `SpreadsheetType` enum in code to reference spreadsheets: `getSpreadsheetId(SpreadsheetType.MAIN)`

## Development

- **Test**: `npm test` (Runs local integration tests using real Sheets API)
- **Deploy**: `npm run deploy` (Pushes to GAS)

## Architecture

- `src/`: Production code (deployed to GAS)
- `test/`: Local-only tests
- `src/core/client.ts`: Universal Client handling GAS/Node environment switching.
